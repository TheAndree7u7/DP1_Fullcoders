<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación en Tiempo Real</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            background-color: #f5f5f5;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.stop {
            background-color: #f44336;
        }
        button.stop:hover {
            background-color: #d32f2f;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            font-weight: bold;
            color: #1976D2;
        }
        .status.active {
            color: #4CAF50;
        }
        .status.inactive {
            color: #F44336;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .stat-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .stat-title {
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
        }
        .progress {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            width: 0%;
        }
        .map-container {
            height: 400px;
            border: 1px solid #ddd;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        .map-item {
            position: absolute;
            transform: translate(-50%, -50%);
        }
        .map-item.almacen {
            width: 20px;
            height: 20px;
            background-color: #2196F3;
            border-radius: 50%;
        }
        .map-item.camion {
            width: 10px;
            height: 10px;
            background-color: #FF9800;
            border-radius: 3px;
        }
        .map-item.pedido {
            width: 8px;
            height: 8px;
            background-color: #F44336;
            border-radius: 50%;
        }
        .log-container {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            background-color: #f5f5f5;
            font-family: monospace;
        }
        .log-entry {
            margin: 2px 0;
            font-size: 12px;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            margin-right: 2px;
        }
        .tab.active {
            background-color: white;
            border: 1px solid #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simulación en Tiempo Real</h1>
        
        <div class="header">
            <div id="tiempo" class="status">Tiempo: Sin iniciar</div>
            <div class="controls">
                <button id="btnIniciar" onclick="iniciarSimulacion()">Iniciar</button>
                <button id="btnDetener" onclick="detenerSimulacion()" class="stop">Detener</button>
                <label>Velocidad: 
                    <select id="velocidad" onchange="cambiarVelocidad(this.value)">
                        <option value="10">10x</option>
                        <option value="60" selected>60x</option>
                        <option value="120">120x</option>
                        <option value="240">240x</option>
                    </select>
                </label>
            </div>
        </div>
        
        <div class="card">
            <h2>Estado de la Simulación</h2>
            <div id="estado" class="status inactive">Inactivo</div>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="cambiarTab(event, 'tabEstadisticas')">Estadísticas</div>
                    <div class="tab" onclick="cambiarTab(event, 'tabMapa')">Mapa</div>
                    <div class="tab" onclick="cambiarTab(event, 'tabLog')">Log</div>
                </div>
                
                <div id="tabEstadisticas" class="tab-content active">
                    <div class="grid" id="estadisticas">
                        <div class="stat-card">
                            <div class="stat-title">Cargando estadísticas...</div>
                        </div>
                    </div>
                </div>
                
                <div id="tabMapa" class="tab-content">
                    <div class="map-container" id="mapa">
                        <!-- Los elementos del mapa se insertarán aquí dinámicamente -->
                    </div>
                </div>
                
                <div id="tabLog" class="tab-content">
                    <div class="log-container" id="log">
                        <div class="log-entry">Sistema listo. Esperando inicio de simulación...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let stompClient = null;
        let simulacionActiva = false;
        
        function conectarWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, frame => {
                console.log('Conectado: ' + frame);
                agregarLog('Conectado al servidor WebSocket.');
                
                stompClient.subscribe('/topic/simulacion', datos => {
                    const datosJson = JSON.parse(datos.body);
                    actualizarInterfaz(datosJson);
                });
                
                // Verificar estado inicial
                verificarEstadoSimulacion();
            }, error => {
                console.error('Error en la conexión WebSocket:', error);
                agregarLog('Error de conexión al WebSocket. Intentando reconectar en 5 segundos...');
                setTimeout(conectarWebSocket, 5000);
            });
        }
        
        function actualizarInterfaz(datos) {
            // Actualizar tiempo
            const tiempo = datos.tiempo;
            if (tiempo) {
                document.getElementById('tiempo').innerText = `Tiempo: ${tiempo}`;
                document.getElementById('tiempo').classList.add('active');
            }
            
            // Actualizar estadísticas
            const estadisticas = datos.estadisticas;
            if (estadisticas) {
                const contenedorEstadisticas = document.getElementById('estadisticas');
                contenedorEstadisticas.innerHTML = '';
                
                // Estadísticas de pedidos
                agregarTarjetaEstadistica(contenedorEstadisticas, 'Pedidos', [
                    { label: 'Pendientes', valor: estadisticas.pedidosPendientes },
                    { label: 'Asignados', valor: estadisticas.pedidosAsignados },
                    { label: 'Entregados', valor: estadisticas.pedidosEntregados },
                    { label: 'Total', valor: estadisticas.totalPedidos }
                ]);
                
                // Estadísticas de camiones
                agregarTarjetaEstadistica(contenedorEstadisticas, 'Camiones', [
                    { label: 'Disponibles', valor: estadisticas.camionesDisponibles },
                    { label: 'En Ruta', valor: estadisticas.camionesEnRuta },
                    { label: 'En Mantenimiento', valor: estadisticas.camionesEnMantenimiento },
                    { label: 'Averiados', valor: estadisticas.camionesAveriados },
                    { label: 'Total', valor: estadisticas.totalCamiones }
                ]);
                
                // Estadísticas de eficiencia
                agregarTarjetaEstadistica(contenedorEstadisticas, 'Eficiencia', [
                    { label: 'Tiempo Promedio (min)', valor: estadisticas.tiempoPromedioEntrega?.toFixed(2) || '0.00' },
                    { label: 'Eficiencia (%)', valor: estadisticas.eficienciaEntrega?.toFixed(2) || '0.00' },
                    { label: 'Consumo (gal)', valor: estadisticas.consumoTotalCombustible?.toFixed(2) || '0.00' }
                ]);
                
                // Actualizar mapa
                actualizarMapa(datos);
                
                // Agregar entrada al log
                agregarLog(`Actualización en ${tiempo}: ${estadisticas.camionesEnRuta} camiones en ruta, ${estadisticas.pedidosEntregados} pedidos entregados.`);
            }
        }
        
        function agregarTarjetaEstadistica(contenedor, titulo, datos) {
            const tarjeta = document.createElement('div');
            tarjeta.className = 'stat-card';
            
            const tituloElem = document.createElement('div');
            tituloElem.className = 'stat-title';
            tituloElem.textContent = titulo;
            tarjeta.appendChild(tituloElem);
            
            datos.forEach(item => {
                const fila = document.createElement('div');
                fila.innerHTML = `${item.label}: <strong>${item.valor}</strong>`;
                tarjeta.appendChild(fila);
            });
            
            contenedor.appendChild(tarjeta);
        }
        
        function actualizarMapa(datos) {
            const mapa = document.getElementById('mapa');
            mapa.innerHTML = '';
            
            // Si hay datos de posición de elementos (almacenes, camiones, pedidos)
            if (datos.posiciones) {
                // Renderizar almacenes
                if (datos.posiciones.almacenes) {
                    datos.posiciones.almacenes.forEach(almacen => {
                        agregarElementoMapa(mapa, almacen.posX, almacen.posY, 'almacen', almacen.nombre);
                    });
                }
                
                // Renderizar camiones
                if (datos.posiciones.camiones) {
                    datos.posiciones.camiones.forEach(camion => {
                        agregarElementoMapa(mapa, camion.posX, camion.posY, 'camion', camion.codigo);
                    });
                }
                
                // Renderizar pedidos
                if (datos.posiciones.pedidos) {
                    datos.posiciones.pedidos.forEach(pedido => {
                        agregarElementoMapa(mapa, pedido.posX, pedido.posY, 'pedido', `Pedido ${pedido.id}`);
                    });
                }
            }
        }
        
        function agregarElementoMapa(contenedor, x, y, tipo, titulo) {
            // Escalar coordenadas al tamaño del mapa (asumiendo mapa de 100x100 unidades)
            const escalaX = contenedor.clientWidth / 100;
            const escalaY = contenedor.clientHeight / 100;
            
            const elemento = document.createElement('div');
            elemento.className = 'map-item ' + tipo;
            elemento.style.left = (x * escalaX) + 'px';
            elemento.style.top = (y * escalaY) + 'px';
            elemento.title = titulo;
            
            contenedor.appendChild(elemento);
        }
        
        function agregarLog(mensaje) {
            const logContainer = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const ahora = new Date();
            const timestamp = ahora.toLocaleTimeString();
            
            logEntry.textContent = `[${timestamp}] ${mensaje}`;
            logContainer.appendChild(logEntry);
            
            // Auto-scroll al final
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function iniciarSimulacion() {
            fetch('/api/simulacion/iniciar-tiempo-real', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.activa) {
                        simulacionActiva = true;
                        document.getElementById('estado').innerText = 'Activo';
                        document.getElementById('estado').className = 'status active';
                        agregarLog('Simulación iniciada.');
                    }
                })
                .catch(error => {
                    console.error('Error al iniciar simulación:', error);
                    agregarLog('Error al iniciar simulación.');
                });
        }
        
        function detenerSimulacion() {
            fetch('/api/simulacion/detener-tiempo-real', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    simulacionActiva = false;
                    document.getElementById('estado').innerText = 'Inactivo';
                    document.getElementById('estado').className = 'status inactive';
                    agregarLog('Simulación detenida.');
                })
                .catch(error => {
                    console.error('Error al detener simulación:', error);
                    agregarLog('Error al detener simulación.');
                });
        }
        
        function cambiarVelocidad(valor) {
            fetch(`/api/simulacion/ajustar-velocidad?factor=${valor}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    agregarLog(`Velocidad ajustada a ${valor}x.`);
                })
                .catch(error => {
                    console.error('Error al ajustar velocidad:', error);
                    agregarLog('Error al ajustar velocidad.');
                });
        }
        
        function verificarEstadoSimulacion() {
            fetch('/api/simulacion/estado')
                .then(response => response.json())
                .then(data => {
                    simulacionActiva = data.activa;
                    document.getElementById('estado').innerText = simulacionActiva ? 'Activo' : 'Inactivo';
                    document.getElementById('estado').className = simulacionActiva ? 'status active' : 'status inactive';
                    
                    if (data.tiempo) {
                        document.getElementById('tiempo').innerText = `Tiempo: ${data.tiempo}`;
                    }
                    
                    agregarLog(`Estado de simulación verificado: ${simulacionActiva ? 'activa' : 'inactiva'}.`);
                })
                .catch(error => {
                    console.error('Error al verificar estado:', error);
                    agregarLog('Error al verificar estado de simulación.');
                });
        }
        
        function cambiarTab(event, tabId) {
            // Desactivar todas las pestañas y contenidos
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activar la pestaña seleccionada
            event.currentTarget.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // Conectar al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            conectarWebSocket();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulaci√≥n en Tiempo Real</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            background-color: #f5f5f5;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.stop {
            background-color: #f44336;
        }
        button.stop:hover {
            background-color: #d32f2f;
        }
        button.info {
            background-color: #2196F3;
        }
        button.info:hover {
            background-color: #0b7dda;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            font-weight: bold;
            color: #1976D2;
        }
        .status.active {
            color: #4CAF50;
        }
        .status.inactive {
            color: #F44336;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .stat-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .stat-title {
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
        }
        .progress {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            width: 0%;
        }
        .progress.warning {
            background-color: #FFC107;
        }
        .progress.danger {
            background-color: #F44336;
        }
        .map-container {
            height: 600px;
            border: 1px solid #ddd;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            background-color: #fcfcfc;
            background-image: linear-gradient(#e3e3e3 1px, transparent 1px), 
                              linear-gradient(90deg, #e3e3e3 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .map-item {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }
        .map-item.almacen {
            width: 24px;
            height: 24px;
            z-index: 10;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2348afe7"><path d="M11,2h2v4H11V2z M20,6.5l-1.5,1.5L10,0.8V0H8v2.5L2.5,7.9L1,6.5L0,7.5L3,10L0,12.5L1,13.5L2.5,12l5.5,4.4V22h8v-5.6 l6.1-4.9L24,13.5L21,10l3-2.5L23,6.5L20,6.5z M8.7,14.8L4,11l4.7-3.8l0.3,0.2L4.4,11l4.6,3.6L8.7,14.8z M19,11l-5,4v5h-4v-5l-5-4V8 l7-5l7,5V11z"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
        }
        .map-item.almacen.central {
            width: 32px;
            height: 32px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230d47a1"><path d="M11,2h2v4H11V2z M20,6.5l-1.5,1.5L10,0.8V0H8v2.5L2.5,7.9L1,6.5L0,7.5L3,10L0,12.5L1,13.5L2.5,12l5.5,4.4V22h8v-5.6 l6.1-4.9L24,13.5L21,10l3-2.5L23,6.5L20,6.5z M8.7,14.8L4,11l4.7-3.8l0.3,0.2L4.4,11l4.6,3.6L8.7,14.8z M19,11l-5,4v5h-4v-5l-5-4V8 l7-5l7,5V11z"/></svg>');
        }
        .map-item.camion {
            width: 20px;
            height: 20px;
            z-index: 5;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234285f4"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
        }
        .map-item.camion.averiado {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f44336"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>');
        }
        .map-item.pedido {
            width: 10px;
            height: 10px;
            background-color: #F44336;
            border-radius: 50%;
        }
        .tooltip {
            position: absolute;
            background-color: white;
            color: black;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
            min-width: 180px;
        }
        .tooltip strong {
            display: block;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .ruta-linea {
            position: absolute;
            background-color: #2196F3;
            height: 3px;
            transform-origin: 0 0;
            z-index: 3;
        }
        .ruta-linea.bloqueo {
            background-color: #F44336;
            height: 5px;
            z-index: 4;
        }
        .info-box {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 200px;
            top: 10px;
            right: 10px;
        }
        .leyenda {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            z-index: 20;
            font-size: 12px;
        }
        .leyenda-titulo {
            font-weight: bold;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .leyenda-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .leyenda-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .leyenda-color.almacen-central {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230d47a1"><path d="M11,2h2v4H11V2z M20,6.5l-1.5,1.5L10,0.8V0H8v2.5L2.5,7.9L1,6.5L0,7.5L3,10L0,12.5L1,13.5L2.5,12l5.5,4.4V22h8v-5.6 l6.1-4.9L24,13.5L21,10l3-2.5L23,6.5L20,6.5z M8.7,14.8L4,11l4.7-3.8l0.3,0.2L4.4,11l4.6,3.6L8.7,14.8z M19,11l-5,4v5h-4v-5l-5-4V8 l7-5l7,5V11z"/></svg>');
            background-repeat: no-repeat;
            background-size: cover;
        }
        .leyenda-color.almacen-intermedio {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2348afe7"><path d="M11,2h2v4H11V2z M20,6.5l-1.5,1.5L10,0.8V0H8v2.5L2.5,7.9L1,6.5L0,7.5L3,10L0,12.5L1,13.5L2.5,12l5.5,4.4V22h8v-5.6 l6.1-4.9L24,13.5L21,10l3-2.5L23,6.5L20,6.5z M8.7,14.8L4,11l4.7-3.8l0.3,0.2L4.4,11l4.6,3.6L8.7,14.8z M19,11l-5,4v5h-4v-5l-5-4V8 l7-5l7,5V11z"/></svg>');
            background-repeat: no-repeat;
            background-size: cover;
        }
        .leyenda-color.camion {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234285f4"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>');
            background-repeat: no-repeat;
            background-size: cover;
        }
        .leyenda-color.bloqueo {
            background-color: #F44336;
            height: 3px;
            width: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simulaci√≥n en Tiempo Real</h1>
        
        <div class="header">
            <div id="tiempo" class="status">Tiempo: Sin iniciar</div>
            <div class="controls">
                <button id="btnIniciar" onclick="iniciarSimulacion()">Iniciar</button>
                <button id="btnDetener" onclick="detenerSimulacion()" class="stop">Detener</button>
                <button id="btnCargarAlmacenes" onclick="cargarAlmacenes()" class="info">Cargar Almacenes</button>
                <label>Velocidad: 
                    <select id="velocidad" onchange="cambiarVelocidad(this.value)">
                        <option value="1">1x</option>
                        <option value="10">10x</option>
                        <option value="60" selected>60x</option>
                        <option value="120">120x</option>
                        <option value="240">240x</option>
                    </select>
                </label>
            </div>
        </div>
        
        <div class="card">
            <h2>Estado de la Simulaci√≥n</h2>
            <div id="estado" class="status inactive">Inactivo</div>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="cambiarTab(event, 'tabEstadisticas')">Estad√≠sticas</div>
                    <div class="tab" onclick="cambiarTab(event, 'tabAlmacenes')">Almacenes</div>
                    <div class="tab" onclick="cambiarTab(event, 'tabMapa')">Mapa</div>
                    <div class="tab" onclick="cambiarTab(event, 'tabLog')">Log</div>
                </div>
                
                <div id="tabEstadisticas" class="tab-content active">
                    <div class="grid" id="estadisticas">
                        <div class="stat-card">
                            <div class="stat-title">Cargando estad√≠sticas...</div>
                        </div>
                    </div>
                </div>
                
                <div id="tabAlmacenes" class="tab-content">
                    <div id="almacenes-container">
                        <div>Cargando informaci√≥n de almacenes...</div>
                    </div>
                </div>
                
                <div id="tabMapa" class="tab-content">
                    <div class="map-container" id="mapa">
                        <!-- Los elementos del mapa se insertar√°n aqu√≠ din√°micamente -->
                        <div id="tooltip" class="tooltip"></div>
                    </div>
                </div>
                
                <div id="tabLog" class="tab-content">
                    <div class="log-container" id="log">
                        <div class="log-entry">Sistema listo. Esperando inicio de simulaci√≥n...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let stompClient = null;
        let simulacionActiva = false;
        let almacenes = [];
        let tooltip = document.getElementById("tooltip");
        
        // A√±adir funci√≥n para cambiar entre pesta√±as
        function cambiarTab(event, tabId) {
            // Ocultar todas las pesta√±as
            const tabsContent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabsContent.length; i++) {
                tabsContent[i].classList.remove("active");
            }
            
            // Remover clase active de todas las pesta√±as
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            
            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabId).classList.add("active");
            
            // A√±adir clase active al tab seleccionado
            if (event && event.currentTarget) {
                event.currentTarget.classList.add("active");
            }
            
            // Si es la pesta√±a del mapa, redimensionar los elementos
            if (tabId === 'tabMapa') {
                const mapa = document.getElementById('mapa');
                mapa.innerHTML = '';
                mapa.appendChild(tooltip);
                cargarAlmacenes();
            }
        }
        
        // Iniciar la conexi√≥n al WebSocket cuando se cargue la p√°gina
        window.onload = function() {
            conectarWebSocket();
        };
        
        function conectarWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, frame => {
                console.log('Conectado: ' + frame);
                agregarLog('Conectado al servidor WebSocket.');
                
                stompClient.subscribe('/topic/simulacion', datos => {
                    const datosJson = JSON.parse(datos.body);
                    actualizarInterfaz(datosJson);
                });
                
                // Verificar estado inicial
                verificarEstadoSimulacion();
                // Cargar almacenes al inicio
                cargarAlmacenes();
            }, error => {
                console.error('Error en la conexi√≥n WebSocket:', error);
                agregarLog('Error de conexi√≥n al WebSocket. Intentando reconectar en 5 segundos...');
                setTimeout(conectarWebSocket, 5000);
            });
        }
        
        function actualizarInterfaz(datos) {
            // Actualizar tiempo
            const tiempo = datos.tiempo;
            if (tiempo) {
                document.getElementById('tiempo').innerText = `Tiempo: ${tiempo}`;
                document.getElementById('tiempo').classList.add('active');
            }
            
            // Actualizar estad√≠sticas
            const estadisticas = datos.estadisticas;
            if (estadisticas) {
                const contenedorEstadisticas = document.getElementById('estadisticas');
                contenedorEstadisticas.innerHTML = '';
                
                // Estad√≠sticas de pedidos
                agregarTarjetaEstadistica(contenedorEstadisticas, 'Pedidos', [
                    { label: 'Pendientes', valor: estadisticas.pedidosPendientes },
                    { label: 'Asignados', valor: estadisticas.pedidosAsignados },
                    { label: 'En Ruta', valor: estadisticas.pedidosEnRuta },
                    { label: 'Entregados', valor: estadisticas.pedidosEntregados },
                    { label: 'Total', valor: estadisticas.totalPedidos }
                ]);
                
                // Estad√≠sticas de camiones
                agregarTarjetaEstadistica(contenedorEstadisticas, 'Camiones', [
                    { label: 'Disponibles', valor: estadisticas.camionesDisponibles },
                    { label: 'En Ruta', valor: estadisticas.camionesEnRuta },
                    { label: 'En Mantenimiento', valor: estadisticas.camionesEnMantenimiento },
                    { label: 'Averiados', valor: estadisticas.camionesAveriados },
                    { label: 'Total', valor: estadisticas.totalCamiones }
                ]);
                
                // Estad√≠sticas de almacenes
                agregarTarjetaEstadistica(contenedorEstadisticas, 'Almacenes', [
                    { label: 'Centrales', valor: estadisticas.almacenesCentrales },
                    { label: 'Intermedios', valor: estadisticas.almacenesIntermedios },
                    { label: 'Total', valor: estadisticas.totalAlmacenes },
                    { label: 'Capacidad GLP (m¬≥)', valor: estadisticas.capacidadTotalGLP?.toFixed(2) || '0.00' },
                    { label: 'GLP Actual (m¬≥)', valor: estadisticas.capacidadActualGLP?.toFixed(2) || '0.00' },
                    { label: 'Ocupaci√≥n GLP (%)', valor: estadisticas.porcentajeOcupacionGLP?.toFixed(2) || '0.00' }
                ]);
                
                // Estad√≠sticas de eficiencia
                agregarTarjetaEstadistica(contenedorEstadisticas, 'Eficiencia', [
                    { label: 'Tiempo Promedio (min)', valor: estadisticas.tiempoPromedioEntrega?.toFixed(2) || '0.00' },
                    { label: 'Eficiencia (%)', valor: estadisticas.eficienciaEntrega?.toFixed(2) || '0.00' },
                    { label: 'Consumo (gal)', valor: estadisticas.consumoTotalCombustible?.toFixed(2) || '0.00' }
                ]);
                
                // Actualizar mapa si hay posiciones
                if (datos.posiciones) {
                    actualizarMapa(datos.posiciones);
                    
                    // Guardar almacenes para uso en otras partes de la interfaz
                    if (datos.posiciones.almacenes) {
                        almacenes = datos.posiciones.almacenes;
                        actualizarDetallesAlmacenes(almacenes);
                    }
                }
                
                // Agregar entrada al log
                agregarLog(`Actualizaci√≥n en ${tiempo}: ${estadisticas.camionesEnRuta} camiones en ruta, ${estadisticas.pedidosEntregados} pedidos entregados.`);
            }
        }
        
        function agregarTarjetaEstadistica(contenedor, titulo, datos) {
            const tarjeta = document.createElement('div');
            tarjeta.className = 'stat-card';
            
            const tituloElem = document.createElement('div');
            tituloElem.className = 'stat-title';
            tituloElem.textContent = titulo;
            tarjeta.appendChild(tituloElem);
            
            datos.forEach(item => {
                const fila = document.createElement('div');
                fila.innerHTML = `${item.label}: <strong>${item.valor}</strong>`;
                tarjeta.appendChild(fila);
            });
            
            contenedor.appendChild(tarjeta);
        }
        
        function actualizarMapa(datos) {
            const mapa = document.getElementById('mapa');
            mapa.innerHTML = '';
            // Volver a a√±adir el tooltip
            mapa.appendChild(tooltip);
            
            // Si hay datos de posici√≥n de elementos (almacenes, camiones, pedidos)
            // Renderizar almacenes
            if (datos.almacenes) {
                datos.almacenes.forEach(almacen => {
                    const elemento = agregarElementoMapa(mapa, almacen.posX, almacen.posY, 
                        almacen.esCentral ? 'almacen central' : 'almacen', 
                        almacen.nombre);
                    
                    // A√±adir datos adicionales al elemento para mostrar en el tooltip
                    elemento.dataset.id = almacen.id;
                    elemento.dataset.nombre = almacen.nombre;
                    elemento.dataset.tipo = almacen.esCentral ? 'central' : 'intermedio';
                    elemento.dataset.glp = `${almacen.capacidadActualGLP.toFixed(2)} / ${almacen.capacidadGLP.toFixed(2)} m¬≥`;
                    elemento.dataset.porcentajeGLP = 
                        (almacen.capacidadGLP > 0 ? (almacen.capacidadActualGLP / almacen.capacidadGLP) * 100 : 0).toFixed(2);
                    
                    // A√±adir evento para mostrar informaci√≥n al pasar el rat√≥n
                    elemento.addEventListener('mouseover', mostrarTooltipAlmacen);
                    elemento.addEventListener('mouseout', ocultarTooltip);
                });
            }
            
            // Renderizar camiones
            if (datos.camiones) {
                datos.camiones.forEach(camion => {
                    const elemento = agregarElementoMapa(mapa, camion.posX, camion.posY, 
                        camion.estado === 3 ? 'camion averiado' : 'camion', 
                        camion.codigo);
                    
                    // A√±adir datos para tooltip
                    elemento.dataset.codigo = camion.codigo;
                    elemento.dataset.tipo = camion.tipo;
                    elemento.dataset.capacidad = camion.capacidad;
                    elemento.dataset.estado = camion.estado;
                    
                    // A√±adir evento para mostrar informaci√≥n
                    elemento.addEventListener('mouseover', mostrarTooltipCamion);
                    elemento.addEventListener('mouseout', ocultarTooltip);
                    
                    // Si est√° averiado, mostrar info de aver√≠a
                    if (camion.estado === 3 && camion.averiaCodigo) {
                        agregarEtiquetaAveria(mapa, camion.posX, camion.posY + 2, `Veh√≠culo ${camion.codigo}`, `Aver√≠a ${camion.averiaCodigo}`);
                    }
                });
            }
            
            // Renderizar pedidos
            if (datos.pedidos) {
                datos.pedidos.forEach(pedido => {
                    const elemento = agregarElementoMapa(mapa, pedido.posX, pedido.posY, 'pedido', `Pedido ${pedido.id}`);
                    
                    // A√±adir datos para tooltip
                    elemento.dataset.id = pedido.id;
                    elemento.dataset.m3 = pedido.m3;
                    elemento.dataset.estado = pedido.estado;
                    
                    // A√±adir evento para mostrar informaci√≥n
                    elemento.addEventListener('mouseover', mostrarTooltipPedido);
                    elemento.addEventListener('mouseout', ocultarTooltip);
                });
            }
            
            // Dibujar cuadr√≠cula para representar las calles
            dibujarCuadricula(mapa);
        }
        
        function agregarInfoGlp(contenedor, x, y, cantidadActual, capacidadTotal) {
            const escalaX = contenedor.clientWidth / 70;
            const escalaY = contenedor.clientHeight / 50;
            
            // Ya no creamos un infoBox permanente, toda la informaci√≥n se mostrar√° en el tooltip
            return null;
        }
        
        function agregarEtiquetaAveria(contenedor, x, y, linea1, linea2) {
            const escalaX = contenedor.clientWidth / 70;
            const escalaY = contenedor.clientHeight / 50;
            
            const infoBox = document.createElement('div');
            infoBox.style.position = 'absolute';
            infoBox.style.left = (x * escalaX) + 'px';
            infoBox.style.top = ((50 - y) * escalaY) + 'px';
            infoBox.style.transform = 'translate(-50%, -50%)';
            infoBox.style.backgroundColor = 'white';
            infoBox.style.padding = '4px 8px';
            infoBox.style.borderRadius = '4px';
            infoBox.style.fontSize = '12px';
            infoBox.style.fontWeight = 'bold';
            infoBox.style.border = '1px solid #f44336';
            infoBox.style.color = '#f44336';
            infoBox.style.zIndex = '15';
            infoBox.style.pointerEvents = 'none';
            infoBox.innerHTML = `${linea1}<br>${linea2}`;
            
            contenedor.appendChild(infoBox);
            return infoBox;
        }
        
        function dibujarRuta(contenedor, puntos, esBloqueada) {
            if (!puntos || puntos.length < 2) return;
            
            const escalaX = contenedor.clientWidth / 70;
            const escalaY = contenedor.clientHeight / 50;
            
            for (let i = 0; i < puntos.length - 1; i++) {
                const p1 = puntos[i];
                const p2 = puntos[i + 1];
                
                // Calcular la longitud y el √°ngulo de la l√≠nea
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const longitud = Math.sqrt(dx * dx + dy * dy);
                const angulo = Math.atan2(dy, dx) * (180 / Math.PI);
                
                // Crear la l√≠nea
                const linea = document.createElement('div');
                linea.className = `ruta-linea ${esBloqueada ? 'bloqueo' : ''}`;
                linea.style.width = (longitud * escalaX) + 'px';
                linea.style.left = (p1.x * escalaX) + 'px';
                linea.style.top = ((50 - p1.y) * escalaY) + 'px';
                linea.style.transform = `rotate(${-angulo}deg)`;
                
                contenedor.appendChild(linea);
            }
        }
        
        function actualizarDetallesAlmacenes(almacenes) {
            const contenedor = document.getElementById('almacenes-container');
            contenedor.innerHTML = '';
            
            if (!almacenes || almacenes.length === 0) {
                contenedor.innerHTML = '<div>No hay almacenes disponibles.</div>';
                return;
            }
            
            almacenes.forEach(almacen => {
                const almacenHTML = crearDetalleAlmacen(almacen);
                contenedor.appendChild(almacenHTML);
            });
        }
        
        function crearDetalleAlmacen(almacen) {
            const detalle = document.createElement('div');
            detalle.className = 'almacen-detail';
            
            const porcentajeGLP = almacen.porcentajeGLP?.toFixed(2) || '0.00';
            let estadoClase = 'success';
            if (porcentajeGLP < 50) estadoClase = 'warning';
            if (porcentajeGLP < 20) estadoClase = 'danger';
            
            detalle.innerHTML = `
                <div class="almacen-header">
                    <div class="almacen-title">${almacen.nombre}</div>
                    <div class="almacen-type ${almacen.esCentral ? 'central' : ''}">${almacen.esCentral ? 'Central' : 'Intermedio'}</div>
                </div>
                <div>Posici√≥n: (${almacen.posX}, ${almacen.posY})</div>
                <div class="almacen-stats">
                    <div class="almacen-stat-item">
                        <div class="almacen-stat-label">Capacidad GLP</div>
                        <div class="almacen-stat-value">${almacen.capacidadGLP.toFixed(2)} m¬≥</div>
                    </div>
                    <div class="almacen-stat-item">
                        <div class="almacen-stat-label">GLP Actual</div>
                        <div class="almacen-stat-value">${almacen.capacidadActualGLP.toFixed(2)} m¬≥</div>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <div>Nivel de GLP:</div>
                        <div>${porcentajeGLP}%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress ${estadoClase}" style="width: ${porcentajeGLP}%"></div>
                    </div>
                </div>
            `;
            
            return detalle;
        }
        
        function agregarElementoMapa(contenedor, x, y, tipo, titulo) {
            // Escalar coordenadas al tama√±o del mapa (70x50)
            const escalaX = contenedor.clientWidth / 70;
            const escalaY = contenedor.clientHeight / 50;
            
            const elemento = document.createElement('div');
            elemento.className = 'map-item ' + tipo;
            elemento.style.left = (x * escalaX) + 'px';
            elemento.style.top = ((50 - y) * escalaY) + 'px'; // Invertir eje Y
            elemento.title = titulo;
            
            contenedor.appendChild(elemento);
            return elemento;
        }
        
        function dibujarCuadricula(contenedor) {
            // Limpiar cualquier cuadr√≠cula existente primero
            const canvasExistente = contenedor.querySelector('canvas');
            if (canvasExistente) {
                contenedor.removeChild(canvasExistente);
            }
            
            const escalaX = contenedor.clientWidth / 70;
            const escalaY = contenedor.clientHeight / 50;
            
            // Crear un canvas para dibujar la cuadr√≠cula
            const canvas = document.createElement('canvas');
            canvas.width = contenedor.clientWidth;
            canvas.height = contenedor.clientHeight;
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.pointerEvents = 'none'; // Para que no interfiera con los clicks
            canvas.style.zIndex = '1'; // Asegurarse que est√© debajo de los elementos
            
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#dddddd';
            ctx.lineWidth = 0.5;
            
            // Dibujar l√≠neas verticales (calles)
            for (let x = 0; x <= 70; x += 5) {
                ctx.beginPath();
                ctx.moveTo(x * escalaX, 0);
                ctx.lineTo(x * escalaX, contenedor.clientHeight);
                ctx.stroke();
            }
            
            // Dibujar l√≠neas horizontales (calles)
            for (let y = 0; y <= 50; y += 5) {
                ctx.beginPath();
                ctx.moveTo(0, y * escalaY);
                ctx.lineTo(contenedor.clientWidth, y * escalaY);
                ctx.stroke();
            }
            
            // Insertar el canvas al principio del contenedor para que quede debajo de todo
            contenedor.insertBefore(canvas, contenedor.firstChild);
        }
        
        function agregarLog(mensaje) {
            const logContainer = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const ahora = new Date();
            const timestamp = ahora.toLocaleTimeString();
            
            logEntry.textContent = `[${timestamp}] ${mensaje}`;
            logContainer.appendChild(logEntry);
            
            // Auto-scroll al final
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function iniciarSimulacion() {
            fetch('/api/simulacion/iniciar-tiempo-real', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.activa) {
                        simulacionActiva = true;
                        document.getElementById('estado').innerText = 'Activo';
                        document.getElementById('estado').className = 'status active';
                        agregarLog('Simulaci√≥n iniciada.');
                    }
                })
                .catch(error => {
                    console.error('Error al iniciar simulaci√≥n:', error);
                    agregarLog('Error al iniciar simulaci√≥n.');
                });
        }
        
        function detenerSimulacion() {
            fetch('/api/simulacion/detener-tiempo-real', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    simulacionActiva = false;
                    document.getElementById('estado').innerText = 'Inactivo';
                    document.getElementById('estado').className = 'status inactive';
                    agregarLog('Simulaci√≥n detenida.');
                })
                .catch(error => {
                    console.error('Error al detener simulaci√≥n:', error);
                    agregarLog('Error al detener simulaci√≥n.');
                });
        }
        
        function cambiarVelocidad(valor) {
            fetch(`/api/simulacion/ajustar-velocidad?factor=${valor}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    agregarLog(`Velocidad ajustada a ${valor}x.`);
                })
                .catch(error => {
                    console.error('Error al ajustar velocidad:', error);
                    agregarLog('Error al ajustar velocidad.');
                });
        }
        
        function cargarAlmacenes() {
            fetch('/api/almacenes')
                .then(response => response.json())
                .then(data => {
                    // El controlador devuelve un objeto con una propiedad 'almacenes'
                    if (data && data.almacenes) {
                        almacenes = data.almacenes;
                        actualizarDetallesAlmacenes(almacenes);
                        agregarLog(`Cargados ${almacenes.length} almacenes (${data.total} activos de ${data.totalEnBD} totales).`);
                        
                        // Tambi√©n actualizar el mapa con los nuevos almacenes
                        const mapa = document.getElementById('mapa');
                        mapa.innerHTML = '';
                        mapa.appendChild(tooltip);
                        
                        almacenes.forEach(almacen => {
                            const elemento = agregarElementoMapa(mapa, almacen.posX, almacen.posY, 
                                almacen.esCentral ? 'almacen central' : 'almacen', 
                                almacen.nombre);
                            
                            // A√±adir datos adicionales al elemento para mostrar en el tooltip
                            elemento.dataset.id = almacen.id;
                            elemento.dataset.nombre = almacen.nombre;
                            elemento.dataset.tipo = almacen.esCentral ? 'central' : 'intermedio';
                            elemento.dataset.glp = `${almacen.capacidadActualGLP.toFixed(2)} / ${almacen.capacidadGLP.toFixed(2)} m¬≥`;
                            elemento.dataset.porcentajeGLP = 
                                (almacen.capacidadGLP > 0 ? (almacen.capacidadActualGLP / almacen.capacidadGLP) * 100 : 0).toFixed(2);
                            
                            // A√±adir evento para mostrar informaci√≥n al pasar el rat√≥n
                            elemento.addEventListener('mouseover', mostrarTooltipAlmacen);
                            elemento.addEventListener('mouseout', ocultarTooltip);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al cargar almacenes:', error);
                    agregarLog('Error al cargar almacenes.');
                });
        }
        
        function mostrarTooltipAlmacen(event) {
            const almacen = event.currentTarget.dataset;
            const porcentaje = parseFloat(almacen.porcentajeGLP);
            let estadoColor = "#4CAF50"; // verde
            if (porcentaje < 50) estadoColor = "#FFC107"; // amarillo
            if (porcentaje < 20) estadoColor = "#F44336"; // rojo
            
            tooltip.innerHTML = `
                <strong>${almacen.nombre}</strong>
                <div>Tipo: ${almacen.tipo === 'central' ? 'Central' : 'Intermedio'}</div>
                <div>Cantidad de GLP: ${almacen.glp}</div>
                <div>Ocupaci√≥n: 
                    <div style="display: inline-block; width: 100px; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-left: 5px;">
                        <div style="height: 100%; background-color: ${estadoColor}; border-radius: 5px; width: ${porcentaje}%;"></div>
                    </div>
                    <span style="margin-left: 5px;">${porcentaje}%</span>
                </div>
            `;
            
            // Posicionar el tooltip cerca del cursor pero evitando que se salga de la pantalla
            const mapContainer = document.getElementById('mapa');
            const mapRect = mapContainer.getBoundingClientRect();
            
            let left = event.clientX + 15;
            let top = event.clientY + 15;
            
            // Asegurarse de que el tooltip no se salga del contenedor del mapa
            if (left + tooltip.offsetWidth > mapRect.right) {
                left = event.clientX - tooltip.offsetWidth - 15;
            }
            
            if (top + tooltip.offsetHeight > mapRect.bottom) {
                top = event.clientY - tooltip.offsetHeight - 15;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.opacity = 1;
        }
        
        function mostrarTooltipCamion(event) {
            const camion = event.currentTarget.dataset;
            tooltip.innerHTML = `
                <strong>Cami√≥n ${camion.codigo}</strong>
                Tipo: ${camion.tipo}<br>
                Capacidad: ${camion.capacidad}<br>
                Estado: ${camion.estado}
            `;
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = event.pageY + 'px';
            tooltip.style.opacity = 1;
        }
        
        function mostrarTooltipPedido(event) {
            const pedido = event.currentTarget.dataset;
            tooltip.innerHTML = `
                <strong>Pedido ${pedido.id}</strong>
                GLP: ${pedido.m3} m¬≥<br>
                Estado: ${pedido.estado}
            `;
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = event.pageY + 'px';
            tooltip.style.opacity = 1;
        }
        
        function ocultarTooltip() {
            tooltip.style.opacity = 0;
        }
    </script>
</body>
</html>